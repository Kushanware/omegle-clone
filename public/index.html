<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stranger Chat</title>
<style>
/* Base Styles */
body { font-family: Arial, sans-serif; margin:0; display:flex; height:100vh; }
.sidebar { width:280px; background:#f9f9f9; padding:12px; border-right:1px solid #eee; overflow-y:auto; }
.chat-container { flex:1; display:flex; flex-direction:column; }
.header { padding:12px; font-size:1.5rem; font-weight:bold; text-align:center; }
.messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; }
.message { padding:12px; border-radius:10px; max-width:70%; word-break:break-word; }
.me { align-self:flex-end; background:#e0dfff; }
.stranger { align-self:flex-start; background:#f1f1f1; }
.system { align-self:center; background:#ffe0b2; font-size:0.9rem; }
.input-area { display:flex; padding:12px; gap:8px; }
input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; }
button { padding:10px 18px; border-radius:8px; border:none; background:#ddd; cursor:pointer; }
button:disabled { background:#aaa; cursor:not-allowed; }

/* Scrollbar small fix */
.messages::-webkit-scrollbar { width:6px; }
.messages::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.2); border-radius:3px; }

/* Responsive Styles */
@media (max-width: 900px) {
    body { flex-direction: column; }
    .sidebar { width:100%; height:auto; border-right:none; border-bottom:1px solid #eee; }
    .chat-container { flex:1; }
    .messages { padding:12px; }
    .input-area { flex-direction: column; gap:6px; padding:8px; }
    button { width:100%; }
}
@media (max-width: 600px) {
    .header { font-size:1.2rem; padding:8px; }
    input { padding:8px; font-size:0.9rem; }
    button { padding:8px; font-size:0.9rem; }
    .message { max-width:90%; padding:8px; font-size:0.9rem; }
}
</style>
</head>
<body>

<div class="sidebar">
  <h3>üë• Online Users</h3>
  <ul id="userList"></ul>
  <div style="margin-top:20px;">
    <label for="nameInput">Your Name:</label><br>
    <input type="text" id="nameInputSidebar" placeholder="Enter your name" style="width: 90%; padding:6px; margin-top:4px;"/>
    <button onclick="updateName()" style="margin-top:4px; padding:6px 12px;">Update</button>
  </div>
</div>

<div class="chat-container">
<div class="header">üí¨ Stranger Chat</div>
<div id="messages" class="messages"></div>
<div class="input-area">
  <input type="text" id="messageInput" placeholder="Type a message..." disabled />
  <button onclick="sendMessage()" disabled>Send</button>
  <button onclick="findNewStranger()">New</button>
</div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
const messagesDiv = document.getElementById("messages");
const userList = document.getElementById("userList");
let isConnected = false;

// Name setup
let userName = localStorage.getItem("userName");
if (!userName) {
    userName = prompt("Enter your name:") || "Anonymous";
    localStorage.setItem("userName", userName);
}
socket.emit("setName", userName);

// Append messages
function appendMessage(text, type){
    const div = document.createElement("div");
    div.className = "message " + type;
    const time = new Date().toLocaleTimeString();
    div.textContent = `[${time}] ${text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Socket listeners
socket.on("strangerFound", (name)=>{
    appendMessage(`üü¢ Connected to ${name}`, "system");
    isConnected = true;
    document.getElementById("messageInput").disabled = false;
    document.querySelector("button[onclick='sendMessage()']").disabled = false;
});

socket.on("waiting", ()=>{
    appendMessage("‚è≥ Waiting for a stranger...", "system");
    isConnected = false;
    document.getElementById("messageInput").disabled = true;
    document.querySelector("button[onclick='sendMessage()']").disabled = true;
});

socket.on("partnerDisconnected", ()=>{
    appendMessage("‚ùå Stranger disconnected", "system");
    isConnected = false;
    document.getElementById("messageInput").disabled = true;
    document.querySelector("button[onclick='sendMessage()']").disabled = true;
});

socket.on("message", (data)=>{
    appendMessage(`${data.from}: ${data.text}`, "stranger");
});

socket.on("systemMessage", (msg)=>{
    appendMessage(msg, "system");
});

socket.on("userList", (users)=>{
    userList.innerHTML = "";
    Object.values(users).forEach(u=>{
        const li = document.createElement("li");
        li.textContent = `${u.name} (${u.status})`;
        userList.appendChild(li);
    });
});

// Send message
function sendMessage(){
    if(!isConnected){
        appendMessage("‚ùå Can't send message. No stranger connected.", "system");
        return;
    }
    const input = document.getElementById("messageInput");
    if(input.value.trim()){
        socket.emit("message", input.value);
        appendMessage("Me: " + input.value, "me");
        input.value = "";
    }
}

// Find new stranger
function findNewStranger(){
    socket.emit("findStranger");
    appendMessage("üîÑ Finding a new stranger...", "system");
    document.getElementById("messageInput").disabled = true;
    document.querySelector("button[onclick='sendMessage()']").disabled = true;
}

function updateName() {
  const input = document.getElementById("nameInputSidebar");
  const newName = input.value.trim();
  if (newName) {
    userName = newName;                       // Update local variable
    localStorage.setItem("userName", userName); // Save locally
    socket.emit("setName", userName);         // Send to server
    appendMessage(`‚úÖ Your name is now: ${userName}`, "system");
  } else {
    alert("Name cannot be empty!");
  }
}

// Initialize the input with current name
document.getElementById("nameInputSidebar").value = userName;

</script>

</body>
</html>
